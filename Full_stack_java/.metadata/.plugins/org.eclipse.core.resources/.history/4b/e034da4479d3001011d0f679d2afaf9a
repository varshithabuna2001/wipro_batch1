package com.TaskManagement.Service;

import java.util.List;
import java.util.Map;
import java.util.regex.Matcher;
import java.util.regex.Pattern;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.TaskManagement.Enum.IssueStatus;
import com.TaskManagement.*;

@Service
public class IntegrationService {

    @Autowired
    private IssueClient issueclient;

    private static final Pattern ISSUE_PATTERN = Pattern.compile("([A-Z]+-\\d+)");

    // --------------------------------------------------------------------
    // HANDLE DIRECT COMMIT MESSAGES
    // --------------------------------------------------------------------
    public void handleCommitMessage(String commitMsg, String author) {
        String issueKey = extractIssueKey(commitMsg);
        if (issueKey == null) return;

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        issueclient.updateStatus(issueId, IssueStatus.DONE, author);
        issueclient.addCommit(issueId, author, "Automatically closed by commit: " + commitMsg);
    }

    // --------------------------------------------------------------------
    // HANDLE PULL REQUEST TITLES
    // --------------------------------------------------------------------
    public void handlePullRequest(String title, String author) {
        String issueKey = extractIssueKey(title);
        if (issueKey == null) return;

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        issueclient.updateStatus(issueId, IssueStatus.IN_PROGRESS, author);
        issueclient.addCommit(issueId, author, "Pull request opened: " + title);
    }

    // --------------------------------------------------------------------
    // PROCESS GITHUB EVENTS
    // --------------------------------------------------------------------
    public void processGithubEvent(String event, Map<String, Object> payload) {

        // PUSH EVENT
        if ("PUSH".equalsIgnoreCase(event)) {

            Object commitObj = payload.get("commits");
            if (!(commitObj instanceof List)) {
                System.out.println("No commits found");
                return;
            }

            List<?> commits = (List<?>) commitObj;

            for (Object obj : commits) {

                if (!(obj instanceof Map)) continue;

                Map<String, Object> c = (Map<String, Object>) obj;

                String msg = (String) c.get("message");

                Map<String, Object> authorMap = (Map<String, Object>) c.get("author");
                String author = authorMap != null ? (String) authorMap.get("name") : "Unknown";

                extractIssueKeyAndUpdate(msg, author);
            }
        }

        // PULL REQUEST
        else if ("PULL_REQUEST".equalsIgnoreCase(event)) {

            Object prObj = payload.get("pull_request");
            if (!(prObj instanceof Map)) {
                System.out.println("No pull_request found in payload");
                return;
            }

            Map<String, Object> pr = (Map<String, Object>) prObj;

            String title = (String) pr.get("title");

            Map<String, Object> userMap = (Map<String, Object>) pr.get("user");
            String author = userMap != null ? (String) userMap.get("login") : "Unknown";

            extractIssueKeyAndMoveInProgress(title, author);
        }
    }

    // --------------------------------------------------------------------
    // HELPERS FOR GITHUB EVENTS
    // --------------------------------------------------------------------
    private void extractIssueKeyAndUpdate(String commitMsg, String user) {

        String issueKey = extractIssueKey(commitMsg);
        if (issueKey == null) return;

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        issueclient.updateStatus(issueId, IssueStatus.DONE, user);
        issueclient.addCommit(issueId, user, "Auto-closed via commit: " + commitMsg);
    }

    private void extractIssueKeyAndMoveInProgress(String title, String user) {

        String issueKey = extractIssueKey(title);
        if (issueKey == null) return;

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        issueclient.updateStatus(issueId, IssueStatus.IN_PROGRESS, user);
    }

    // --------------------------------------------------------------------
    // JENKINS EVENT PROCESSOR
    // --------------------------------------------------------------------
    public void processJenkinsEvent(Map<String, Object> body) {

        String jobName = (String) body.get("name");
        String result = (String) body.get("result");
        String log = (String) body.get("log");

        String issueKey = extractIssueKey(jobName);
        if (issueKey == null) return;

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        if ("FAILURE".equalsIgnoreCase(result)) {
            issueclient.addCommit(issueId, "Jenkins",
                    "Build Failed\n==== LOG START ====\n" + log + "\n==== LOG END ====");
        }
    }

    // --------------------------------------------------------------------
    // DOCKER EVENT HANDLER
    // --------------------------------------------------------------------
    public void processDockerEvent(Map<String, Object> payload) {

        String status = (String) payload.get("status");
        String image = (String) payload.get("from");

        Map<String, Object> actor = (Map<String, Object>) payload.get("Actor");
        Map<String, Object> attributes = actor != null ? (Map<String, Object>) actor.get("Attributes") : null;

        String containerName = attributes != null ? (String) attributes.get("name") : "";
        String imageName = attributes != null ? (String) attributes.get("image") : image;

        String issueKey = extractIssueKey(containerName + " " + imageName);

        if (issueKey == null) {
            System.out.println("No issue key found in docker payload");
            return;
        }

        Long issueId = Long.parseLong(issueKey.split("-")[1]);

        switch (status.toLowerCase()) {

            case "start":
                issueclient.updateStatus(issueId, IssueStatus.DEPLOYMENT, "Docker");
                issueclient.addCommit(issueId, "Docker", "Container started | Image: " + imageName);
                break;

            case "die":
                issueclient.updateStatus(issueId, IssueStatus.BLOCKS, "Docker");
                issueclient.addCommit(issueId, "Docker", "Container crashed | Image: " + imageName);
                break;

            case "pull":
                issueclient.addCommit(issueId, "Docker", "Image pulled: " + imageName);
                break;

            case "build":
                issueclient.addCommit(issueId, "Docker", "Docker image built: " + imageName);
                break;

            default:
                issueclient.addCommit(issueId, "Docker",
                        "Docker Event: " + status + " | Image: " + imageName);
        }
    }

    // --------------------------------------------------------------------
    // UNIVERSAL ISSUE KEY EXTRACTOR
    // --------------------------------------------------------------------
    private String extractIssueKey(String text) {
        if (text == null) return null;

        Matcher matcher = ISSUE_PATTERN.matcher(text);
        return matcher.find() ? matcher.group(1) : null;
    }
}
